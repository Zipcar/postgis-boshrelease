#!/bin/bash -eu

job_dir=/var/vcap/jobs/postgis

postgres_version=$(grep 'current_version="' /var/vcap/jobs/postgres/bin/pgconfig.sh | sed 's/"//g' | sed 's/current_version\=//')
postgis_source_folder=/var/vcap/packages/postgis/postgres-${postgres_version}
postgres_target_folder=/var/vcap/packages/postgres-${postgres_version}

cp -r ${postgis_source_folder}/* ${postgres_target_folder}
# remove the postgis/${postgres_version} folder here

source_envrc_file=". ${job_dir}/envrc"

# for profile in /root/.profile /etc/skel/.profile /var/vcap/jobs/postgres/bin/pgconfig.sh; do
for pgconfig_file in /var/vcap/jobs/postgres/bin/pgconfig.sh; do
  if ! grep -q "^${source_envrc_file}\$" ${pgconfig_file} >/dev/null 2>&1; then
    echo "${source_envrc_file}" >> ${pgconfig_file}
  fi
done